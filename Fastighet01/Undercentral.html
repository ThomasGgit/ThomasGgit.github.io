<!DOCTYPE html>
<html>
	<head>
		<title>Undercentral</title>
		
		<meta name="robots" content="none">
		
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /> 
		<meta http-equiv="Pragma" content="no-cache" /> 
		<meta http-equiv="Expires" content="0" />

		<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
		<script src="https://unpkg.com/stackedit-js@1.0.7/docs/lib/stackedit.min.js"></script>
		<script type="text/javascript" src="/yaml.js"></script>

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
		
		<style>
			body {
			  margin: 0;
			  font-family: "Lato", sans-serif;
			}
			
			.main img {
			  width: 100%;
			  height: auto;
			}
			
			.mainnav {
				border-right-style: groove;
				border-width: 1px;
				margin: 0;
				padding: 0;
				width: 169px;
				background-color: #f1f1f1;
				position: fixed;
				height: 100%;
				overflow: hidden;
				transition: 0.5s;
			}

			.mainnav a, .mainnav .dropdown-btn {
				padding: 6px 0px 6px 16px;
				text-decoration: none;
				font-size: 20px;
				color: #818181;
				display: block;
				border: none;
				background: none;
				width: 100%;
				text-align: left;
				cursor: pointer;
				outline: none;
				transition: 0.3s;
			}
			 
			.mainnav .active {
			  color: #04AA6D;
			}

			.mainnav a:hover:not(.active), .mainnav .dropdown-btn:hover:not(.active) {
			  color: #000;
			}
			
			.mainnav .closebtn {
				font-size: 24px;
			}
			.mainnav .fa-times-circle {
			  float: right;
			  padding-right: 28px;
			}

			/* Dropdown container (hidden by default). Optional: add a lighter background color and some left padding to change the design of the dropdown content */
			.mainnav .dropdown-container {
				display: none;
				padding-left: 8px;
			}
			
			/* Optional: Style the caret down icon */
			.mainnav .fa-caret-down {
			  float: right;
			  padding-right: 8px;
			}
			
			.sidebar {
				border-right-style: groove;
				border-width: 1px;
				left: 170px;
				margin: 0;
				padding: 0;
				width: 100px;
				background-color: #f1f1f1;
				position: fixed;
				height: 100%;
				overflow: auto;
			}

			.sidebar a {
			  display: block;
			  color: black;
			  padding: 10px;
			  text-decoration: none;
			}
			 
			.sidebar a.active {
			  background-color: #04AA6D;
			  color: white;
			}

			.sidebar a:hover:not(.active) {
			  background-color: #555;
			  color: white;
			}

			div.main {
			  margin-left: 270px;
			  padding: 1px 16px;
			  height: 1000px;
			}

			@media screen and (max-width: 700px) {
			  .mainnav {
				width: 100%;
				height: auto;
				position: relative;
			  }
			  .sidebar {
				left: 0px;
				width: 100%;
				height: auto;
				position: relative;
			  }
			  .sidebar a {float: left;}
			  .mainnav a, .mainnav .dropdown-btn {float: left;}
			  div.main {margin-left: 0;}
			}

			@media screen and (max-width: 400px) {
			  .sidebar a {
				text-align: center;
				float: none;
			  }
			  .mainnav a, .mainnav .dropdown-btn {
				text-align: center;
				float: none;
			  }
			}
			
			.table-wrapper table {
			  border-collapse: collapse;
			  border: 1px solid grey;
			  table-layout: auto;
			  width: 100%; 
			}
			.table-wrapper th, .table-wrapper td{
			  border: 1px solid grey;
			}
			
			div.main #content h2 {
				margin-top: 18px;
				margin-bottom: 10px;
			}
			div.main #content h3 {
				margin-top: 12px;
				margin-bottom: 10px;
			}
			div.main #content p {
				margin-top: 0px;
				margin-bottom: 0px;
			}
			
		</style>

		<script>
			/*
				https://thomasggit.github.io/
				
				https://benweet.github.io/stackedit.js/
				
				https://zerodevx.github.io/zero-md/
				
				https://github.com/jeremyfa/yaml.js
				
				
				Krav:
					Inlogg
					URL
					Editering
					Dynamiskt
					
				Att lösa:
					-Flera system
					-Bookmarks
					Tabeller med larm, inställningar, mätvärden
						Lägga alltid sist efter en system-tag?
					Klicka upp utförligare info
					SVG inbäddning
					Inställningsvärden i tabellen, hur få till detta?
						Använda yaml som säger vilka som finns
						Sen i undercentral.yaml läggs nya till och kan ändra aktuella inställningar
					Börvärdeskurvor
					-Läsa in templates dynamiskt efter vilka som används
					Skapa bookmarks dynamiskt efter vilka system som finns
					Ersätta taggar dynamiskt efter vilka som finns
					
				Framtida:
					Hämta eller ta emot info kring vad som är aktivt
						Kanske även aktuella inställningar för diverse?
					Redigera sidor
					redigering av metadata (yaml)
					Export PDF och SVG
					Sidhuvud och sidfot i export
					SVG, där även symbolnamnen byts ut
					Klicka på symbol i SVG så highlightas den i texten
					Styles
					Ladda upp andra filer
					Tooltip/hänvisa vad som är standardtext kontra icke
					Lägga in aktuella inställningar i texten, alternativt hänvisa eller tooltip
				
			*/
			var undercentral = {};
			var mallTexter = {};
			
			const stackedit = new Stackedit();
			
			$(document).ready(function(){
				console.log('Version 0.0.0.40');
				
				
				$(".dropdown-btn").click(function() {
					$(this).toggleClass("active");
					var dropdownContent = $(this).next();
					if ($(this).hasClass("active")) {
						$(dropdownContent).show();
					} else {
						$(dropdownContent).hide();
					}
				});
				$(".dropdown-btn").each(function() {
					var dropdownContent = $(this).next();
					if ($(this).hasClass("active")) {
						$(dropdownContent).show();
					} else {
						$(dropdownContent).hide();
					}
				});
				
				
				
				$.get( "/Fastighet01/Undercentral.md", function( data ) {
					//console.log(data);
					
					undercentral.md = data;
					
					//console.log(undercentral);
					
					getTemplates();
				});
				
				$.get( "/Fastighet01/Undercentral.yaml", function( data ) {
					//console.log(data);
					
					undercentral.yaml = YAML.parse(data);
					
					console.log(undercentral);
					getTemplates();
				});
				
			});
			
			
			var labb2doneCount = 0;
			function getTemplates () {
				if (++labb2doneCount == 2){
					
					var mallobjects2 = undercentral.md.match(/!\[\[[^\]]+\]\]/gi);
					//console.log(mallobjects2);
					var mallobjects = [];
					$.each(mallobjects2, function(i, el){
						if($.inArray(el, mallobjects) === -1) mallobjects.push(el);
					});
			
					$.each(mallobjects, function(i, mallobject){
						var test = mallobject.replace("![[","").replace("]]","");
						mallTexter[test] = {};
						//var text = "/Malltexter/" + test + ".md";
						var text = test;
						
						$.get( text+".md", function( data ) {
							//console.log(data);
							mallTexter[test].md = data;
						}).always(function() {
							labb1();
						});;
						
						$.get( text+".yaml", function( data ) {
							//console.log(data);
							mallTexter[test].yaml = YAML.parse(data);
						}).always(function() {
							labb1();
						});;
						
					});
					
				}
			}
			
			
			var labb1doneCount = 0;
			function labb1 () {
				if (++labb1doneCount == 8){
				
					var el = $('#content');
					
					//console.log(undercentral.text);
					
					// Replaces text with templates
					undercentral.text = undercentral.md;
					$.each(mallTexter, function(key, value){
						undercentral.text = undercentral.text.replace("![["+key+"]]", value.md);
					});
					//console.log(undercentral.text);
					
					
					// Split different text of different systems
					var test1Old = 0;
					var test1 = undercentral.text.indexOf("#system-", test1+1);
					var text = [];
					while (test1 > 0) {
						//console.log(test1);
						text.push(undercentral.text.substring(test1Old, test1));
						
						test1Old = test1;
						test1 = undercentral.text.indexOf("#system-", test1+1);
					}
					text.push(undercentral.text.substring(test1Old));
					//console.log(text);
					
					
					systemsSidebarAddItem();
					systemsSidebarAddItem('Home', '');
					
					
					// Replacing tags in each system-text 
					undercentral.text = "";
					for (var i=0;i<text.length; i++) {
						//console.log("hej1");
					
						//console.log(text[i]);
						
						if (undercentral.yaml.cabinet != undefined)
							text[i] = text[i].replace(/#cabinet/gi, undercentral.yaml.cabinet);
						if (undercentral.yaml.address != undefined)
							text[i] = text[i].replace(/#address/gi, undercentral.yaml.address);
						if (undercentral.yaml.positioned != undefined)
							text[i] = text[i].replace(/#positioned/gi, undercentral.yaml.positioned);
						
						var systemName;
						text[i] = text[i].replace(/#system-[A-Ö,a-ö,0-9]+\s/i, function (x){
							systemName = x.replace("#system-", "").trim();
							systemsSidebarAddItem('systemName', 'System-'+systemName);
							return "## System " + systemName + "\n";
						});
						//console.log(systemName);
						
						if (systemName != undefined) {
							var yaml2;
							for (var j=0;j<undercentral.yaml.systems.length; j++) {
								if (undercentral.yaml.systems[j].name.trim() === systemName)
									yaml2 = undercentral.yaml.systems[j];
							}
							if (yaml2 != undefined) {
								if (yaml2.components.forwardtemp != undefined)
									text[i] = text[i].replace(/#forwardtemp/g, yaml2.components.forwardtemp.name);
								if (yaml2.components.returntemp != undefined)
									text[i] = text[i].replace(/#returntemp/g, yaml2.components.returntemp.name);
								if (yaml2.components.pump != undefined)
									text[i] = text[i].replace(/#pump/g, yaml2.components.pump.name);
							}
						}
						
						//console.log("hej2");
						undercentral.text += text[i];
						//console.log("hej3");
					}
					//console.log(undercentral.text);
					
					stackedit.openFile({
						content: { text: undercentral.text }
					}, true);
					
					
					stackedit.on('fileChange', (file) => {
						//console.log(file);
						el.html(file.content.html);
					});
				}
			}
			
			
			function systemsSidebarAddItem (text, id) {
				var sidebar = $('#systemsSidebar');
				
				if (text == null || text == '') {
					$(sidebar).empty();
					return;
				}
				
				var txt2 = $("<a></a>").text(text).attr('href', '#'+id.toLowerCase() );
				$(sidebar).append(txt2);
			}
			
			
		</script>

	</head>

	<body>
		<div class="mainnav">
			<!--<a href="javascript:void(0)" class="closebtn" onclick="closeNav()"><i class="fa fa-times-circle" aria-hidden="true"></i></a>-->
			<a href="/start.html">Start</a>
			<button class="dropdown-btn active">Driftkort<i class="fa fa-caret-down"></i></button>
			<div class="dropdown-container">
				<button class="dropdown-btn active">Fastighet 01<i class="fa fa-caret-down"></i></button>
				<div class="dropdown-container">
					<a class="active" href="/Fastighet01/Undercentral.html">Undercentral</a>
				</div>
			</div>
			<a href="/about.html">Om</a>
		</div>
		
		<div class="sidebar" id="systemsSidebar">
			<a>hej</a>
		</div>
			
		<div class="main">
			<div id="content"></div>
		</div>

	</body>
</html>